<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Product Code Uploader with Resume</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .hidden { display: none; }
        #progress { margin: 10px 0; }
        .error { color: red; }
        .success { color: green; }
        .warning { color: orange; }
        #resumeSection { margin-top: 20px; }
    </style>
</head>
<body>
    <div id="uploadSection">
        <h2>Upload Product Codes</h2>
        <input type="file" id="fileInput" accept=".xlsx, .xls">
        <button onclick="uploadFile()">Upload to Database</button>
        <p id="status"></p>
        <div id="progress"></div>
        <div id="resumeSection" class="hidden">
            <h3>Resume Upload</h3>
            <p>Last processed row: <span id="lastRow">0</span></p>
            <button onclick="resumeUpload()">Resume from Last Position</button>
        </div>
    </div>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDX89iKbSulLbxz3qPxLlcuKCMF-qqptwA",
            authDomain: "pricelistscanner.firebaseapp.com",
            projectId: "pricelistscanner",
            storageBucket: "pricelistscanner.appspot.com",
            messagingSenderId: "925350073765",
            appId: "1:925350073765:web:4c6f0d1c0471df1df0c44c"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let globalWorkbook = null;
        let lastProcessedRow = 0;
        const BATCH_SIZE = 25; // Smaller batch size
        const DELAY_BETWEEN_BATCHES = 1000; // 1 second delay between batches

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function processRowBatch(jsonData, startRow, endRow) {
            const batch = db.batch();
            let successful = 0;
            let skipped = 0;

            for (let i = startRow; i < Math.min(endRow, jsonData.length); i++) {
                const row = jsonData[i];
                if (!row['Product Number']) {
                    skipped++;
                    continue;
                }

                const docRef = db.collection('products').doc(row['Product Number'].toString().trim());
                batch.set(docRef, {
                    accountSelection: (row['Account Selection'] || '').toString().trim(),
                    sku: row['Product Number'].toString().trim(),
                    description: (row['Product Description'] || '').toString().trim(),
                    searchDescription: (row['Search Description'] || '').toString().trim(),
                    packWeight: typeof row['Pack Weight'] === 'number' ? 
                        row['Pack Weight'] : 
                        parseFloat(row['Pack Weight']) || 0,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

                successful++;
            }

            await batch.commit();
            return { successful, skipped };
        }

        async function processExcelData(jsonData, startFromRow = 0) {
            const statusEl = document.getElementById('status');
            const progressEl = document.getElementById('progress');
            const resumeSection = document.getElementById('resumeSection');
            const lastRowEl = document.getElementById('lastRow');

            let totalSuccessful = 0;
            let totalSkipped = 0;

            try {
                for (let i = startFromRow; i < jsonData.length; i += BATCH_SIZE) {
                    statusEl.textContent = `Processing rows ${i + 1} to ${Math.min(i + BATCH_SIZE, jsonData.length)} of ${jsonData.length}...`;
                    progressEl.textContent = `Progress: ${Math.floor((i / jsonData.length) * 100)}%`;

                    try {
                        const { successful, skipped } = await processRowBatch(jsonData, i, i + BATCH_SIZE);
                        totalSuccessful += successful;
                        totalSkipped += skipped;
                        lastProcessedRow = i + BATCH_SIZE;
                        lastRowEl.textContent = lastProcessedRow;
                        
                        // Save progress to localStorage
                        localStorage.setItem('lastProcessedRow', lastProcessedRow);
                        
                        // Add delay between batches
                        await sleep(DELAY_BETWEEN_BATCHES);
                    } catch (error) {
                        console.error('Batch error:', error);
                        statusEl.textContent = `Error at row ${i + 1}. You can resume from this point.`;
                        statusEl.className = 'error';
                        resumeSection.classList.remove('hidden');
                        throw error;
                    }
                }

                statusEl.textContent = `Upload complete! Successfully uploaded ${totalSuccessful} records. ${totalSkipped} records skipped.`;
                statusEl.className = 'success';
                localStorage.removeItem('lastProcessedRow'); // Clear progress on successful completion
            } catch (error) {
                console.error('Processing error:', error);
                resumeSection.classList.remove('hidden');
            }
        }

        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const statusEl = document.getElementById('status');
            
            if (!fileInput.files.length) {
                alert('Please select a file first.');
                return;
            }

            const file = fileInput.files[0];
            statusEl.textContent = 'Reading file...';

            try {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        globalWorkbook = workbook;
                        
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: '' });

                        await processExcelData(jsonData);
                    } catch (error) {
                        console.error('Error processing file:', error);
                        statusEl.textContent = 'Error: ' + error.message;
                        statusEl.className = 'error';
                    }
                };

                reader.readAsArrayBuffer(file);
            } catch (error) {
                console.error('Error reading file:', error);
                statusEl.textContent = 'Error: ' + error.message;
                statusEl.className = 'error';
            }
        }

        async function resumeUpload() {
            if (!globalWorkbook) {
                alert('Please upload the file again to resume.');
                return;
            }

            const firstSheetName = globalWorkbook.SheetNames[0];
            const worksheet = globalWorkbook.Sheets[firstSheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: '' });
            
            const savedRow = parseInt(localStorage.getItem('lastProcessedRow')) || lastProcessedRow;
            await processExcelData(jsonData, savedRow);
        }

        // Check for saved progress on page load
        window.onload = function() {
            const savedRow = localStorage.getItem('lastProcessedRow');
            if (savedRow) {
                document.getElementById('lastRow').textContent = savedRow;
                document.getElementById('resumeSection').classList.remove('hidden');
            }
        };
    </script>
</body>
</html>
